@using DataAccessLayer.Helpers

<!DOCTYPE html>

<html>
<head>
    <title>TechCity | @ViewBag.Title</title>
    <meta charset="utf-32">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="~/Content/Signature/assets/jquery.signaturepad.css" rel="stylesheet">
    <link href="~/Content/Styles/font-awesome.min.css" rel="stylesheet" />
    <link href="~/Content/Styles/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="~/Content/Styles/jquery.dataTables_themeroller.css" rel="stylesheet" />
    <link href="~/Content/Styles/dataTables.responsive.css" rel="stylesheet" />
    <link href="~/Content/style.css" rel="stylesheet" />
    <link href="~/Content/themes/base/all.css" rel="stylesheet" />
    <link href="~/Content/Styles/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/jquery.toastmessage.css" rel="stylesheet" />
    <link href="~/Content/themes/pos/bootstrap-tabdrop/tabdrop.css" rel="stylesheet" />
    <link href="~/Content/selectize.bootstrap3.css" rel="stylesheet" />
    <link href="~/Content/selectize.css" rel="stylesheet" />
    <link href="~/Content/selectize.default.css" rel="stylesheet" />
    <link href="~/Content/themes/pos/components-rounded.min.css" rel="stylesheet" />
    <link href="~/Content/themes/pos/plugins.min.css" rel="stylesheet" />
    <link href="~/Content/themes/pos/layout.min.css" rel="stylesheet" />
    <link href="~/Content/themes/pos/light.min.css" rel="stylesheet" />
    <link href="~/Scripts/Kendo/kendo.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Scripts/Kendo/kendo.common.min.css" rel="stylesheet" />
    <link href="~/Content/languages.css" rel="stylesheet" />
    <link href="~/Content/Styles/mystyle.css?v=1.7" rel="stylesheet" />
    @*<link href='https://fonts.googleapis.com/css?family=Libre Barcode 39' rel='stylesheet'>*@

    <style>
        /*.barcode {
            font-family: 'Libre Barcode 39';font-size: 22px;
        }*/
        /*body {
                    background-color:darkslateblue !important;
                }

                .form-control {
                    background-color: dodgerblue;
                    color: white;
                }*/

        .datepicker {
            width: 100%;
        }

        .ui-autocomplete {
            min-height: 200px;
        }
    </style>
</head>
<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo">

    <audio src="~/Content/keypress.wav" style="display:none;" autostart="false" width="0" height="0" id="keypresssound"
           enablejavascript="true"></audio>

    <audio src="~/Content/beep.wav" autostart="false" style="display:none;" width="0" height="0" id="beep"
           enablejavascript="true"></audio>
    @RenderBody()
    <div class="overlay">
    </div>
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Scripts/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/Kendo/kendo.all.min.js"></script>
    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/jquery-ui-1.11.3.min.js"></script>

    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="~/SignalR/hubs/"></script>

    <script src="~/Scripts/modernizr-2.5.3.js"></script>
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/Scripts/forms.min.js"></script>
    <script src="~/Scripts/jquery.toastmessage.js"></script>
    <script src="~/Scripts/buttons.js"></script>

    @*<script src="~/Scripts/plugins/bootstrap-hover-dropdown/bootstrap-hover-dropdown.min.js"></script>*@
    <script src="~/Scripts/plugins/jquery-slimscroll/jquery.slimscroll.min.js"></script>
    <script src="~/Scripts/plugins/qrious.min.js"></script>

    <script src="~/Scripts/POS/pos/bootstrap-tabdrop/bootstrap-tabdrop.js" type="text/javascript"></script>
    <script src="~/Scripts/dataTables.responsive.js"></script>
    <script src="~/Scripts/selectize.js"></script>

    <script src="~/Content/Signature/assets/jquery.signaturepad.js"></script>
    <script src="~/Content/Signature/assets/json2.min.js"></script>

    <script src="~/Scripts/POS/pos/app.js"></script>
    <script src="~/Scripts/POS/pos/layout.js"></script>
    <script src="~/Scripts/POS/pos/pos.js?v=1.91"></script>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/barcodes/JsBarcode.code128.min.js"></script>

    <div id="dueSalePayemntWindow" style="overflow:hidden;">

    </div>

    <div style="display:none;" id="qr-code-container">
        <canvas id="qr-code"></canvas>
    </div>

    <div style="display:none;" id="barcode-container">
        <canvas id="barcode"></canvas>
    </div>

    <script type="text/javascript">
    var notificationHub = null;
    // notification hub
    (function () {
        // Defining a connection to the server hub.
        notificationHub = $.connection.notifyHub;
        // Setting logging to true so that we can see whats happening in the browser console log. [OPTIONAL]
        $.connection.hub.logging = true;
        // Start the hub
        $.connection.hub.start();

        // Client method to broadcast the message

    }());


    var dispatchWin = $("#dueSalePayemntWindow");

    dispatchWin.kendoWindow({
        width: "600px",
        title: false,
        visible: false,
        modal: true
    });

    setInterval(function () { refreshSession() }, 6000);
    //NotificationTicker();
    var pressed = false;
    var chars = [];
    $(document).unbind("keypress");
    $(document).keypress(function (e) {
        if ((e.key === 'd' || e.key === 'D')) {  // 'd' key
            if (!deleteCurrentCartItem) {
                return;
            }
            if (confirm("Are you sure you want to delete it?")) {
                removeCartItem();
            }
            e.preventDefault();
            return false;
        }

        //if (
        //    (e.which >= 48 && e.which <= 57) ||   // 0–9
        //    (e.which >= 65 && e.which <= 90) ||   // A–Z
        //    (e.which >= 97 && e.which <= 122)     // a–z
        //) {
        //    console.log('char push:', e.which);
        //    chars.push(String.fromCharCode(e.which));
        //}
        if (/^[a-zA-Z0-9]$/.test(e.key)) {
            console.log('char push:', e.key);
            chars.push(e.key);
        }
        //console.log(e.which + ":" + chars.join("|"));
        
        if (pressed === false) {

            setTimeout(function () {

                if (chars.length >= 8) {
                    var $focused = $(':focus');
                    if (!$focused.is(':button')) {
                        $focused.val("");
                    }

                    var barcode = chars.join("");

                    // assign value to some input (or do whatever you want)
                    addToCart(barcode);

                    barcode = "";
                }
                chars = [];
                pressed = false;
            }, 500);
        }
        pressed = true;
    });

    $(document).unbind("keydown");
    $(document).keydown(function (e) {

        if (e.keyCode === 27) { // esc key
            if (windowIsOpen("cartItemActionWindow")) {
                closeCartItemActionWindow();
            }
            if (windowIsOpen("newCartItemWindow")) {
                closeNewCartItemWindow();
            }
            $("#searchItemQuery").val("");
            $("#searchItemQuery").focus();
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 't' || e.key === 'T')) { // 't' key
            taxApplied();
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 'l' || e.key === 'L')) { // 'l' key
            taxLess();
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 'f' || e.key === 'F')) { // 'c' key
            openFirstNationsTaxDetailWindowWindow();
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 'c' || e.key === 'C')) {
            addPayment('@Constants.CashSale');
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 'r' || e.key === 'R')) {
            addPayment('@Constants.CreditCardSale');
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 'd' || e.key === 'D')) {
            addPayment('@Constants.DebitCardSale');
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 's' || e.key === 'S')) {
            addPayment('@Constants.StoreCreditSale');
            e.preventDefault();
            return false;
        }
        if (e.altKey && e.shiftKey && (e.key === 'p' || e.key === 'P')) {
            printLastInvoice();
            e.preventDefault();
            return false;
        }
        if (e.altKey && (e.key === 'p' || e.key === 'P')) {
            addSale();
            e.preventDefault();
            return false;
        }

        if (e.altKey && (e.key === 'n' || e.key === 'N')) {
            if (!windowIsOpen("newCartItemWindow")) {
                openNewCartItemWindow();
            }
            e.preventDefault();
            return false;
        }
       
        if (e.key === 'Enter') {
            if (windowIsOpen("cartItemActionWindow")) {
                closeCartItemActionWindow();
            }
            if (windowIsOpen("newCartItemWindow")) {
                addAnonymousCartItem();
            }
            e.preventDefault();
            return false;
        }
        });

        //$(":input").keypress(function (event) {
        //    if (event.which == '10' || event.which == '13') {
        //        event.preventDefault();
        //    }
        //});

        $(document).ready(function () {
            $("#cartGrid").on("dblclick", "tr.k-state-selected", function () {
                if (currentCartItem) {
                    $(".currentItem_Qty").val(currentCartItem.Qty);
                    itemQtyKeppadVal = "";
                    $("#cartItemPriceInput").val(currentCartItem.Price);
                    itemPriceKeppadVal = "";
                    $("#cartItemTaxInput").val(currentCartItem.TaxRate);

                    var win = $("#cartItemActionWindow").data("kendoWindow");
                    win.center().open();
                    setTimeout(function () { $("#cartItemPriceInput").focus(); }, 1000);
                    return;
                }
            });


        });

        function formatAspNetDate(jsonDate) {
            if (!jsonDate) return "";

            // Extract timestamp from /Date(1761206127400)/
            var timestamp = parseInt(jsonDate.replace(/[^0-9]/g, ""));
            var date = new Date(timestamp);

            let day = String(date.getDate()).padStart(2, "0");
            let month = String(date.getMonth() + 1).padStart(2, "0");
            let year = date.getFullYear();

            let hours = date.getHours();
            let minutes = String(date.getMinutes()).padStart(2, "0");
            let seconds = String(date.getSeconds()).padStart(2, "0");

            let ampm = hours >= 12 ? "PM" : "AM";
            hours = hours % 12;
            hours = hours ? hours : 12;
            hours = String(hours).padStart(2, "0");

            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds} ${ampm}`;
        }


    </script>



    <script>
        //TEST CASE FOR SCANNER //
        function simulateScan(barcode) {
            let index = 0;

            function triggerNextChar() {
                if (index >= barcode.length) return;

                let char = barcode[index];
                index++;

                // Create a keypress event
                var e = jQuery.Event("keypress");
                e.which = char.charCodeAt(0);
                e.key = char;

                // Trigger keypress
                $(document).trigger(e);

                // Simulate scanner speed (really fast)
                setTimeout(triggerNextChar, 10);
            }

            triggerNextChar();
        }

    </script>
</body>

</html>
